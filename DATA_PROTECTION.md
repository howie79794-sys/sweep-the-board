# 数据保护机制说明

## 概述

本项目实现了严格的数据保护机制，确保在每次部署或更新时，**绝不会覆盖或删除已有的生产数据**。

## 保护机制

### 1. 数据库初始化保护

`backend/database/init_db.py` 脚本实现了三重检查机制：

1. **用户数据检查**：如果数据库中存在任何用户记录，跳过初始化
2. **资产数据检查**：如果数据库中存在任何资产记录，跳过初始化  
3. **市场数据检查**：如果数据库中存在任何市场数据记录，跳过初始化

**只要有任何一项数据存在，就会完全跳过初始化，绝不会覆盖已有数据。**

### 2. 启动脚本保护

`start.sh` 中的初始化逻辑：

- 仅在数据库完全为空时初始化数据
- 如果初始化脚本执行失败，不影响服务启动
- 日志明确显示是否跳过了初始化（保护已有数据）

### 3. 数据库文件保护

- 数据库文件存储在 `/app/data/database.db`（使用 Persistent Storage）
- 数据库文件不会被 Git 跟踪（已加入 `.gitignore`）
- 部署时不会删除或重置数据库文件

## 部署流程

1. **首次部署**：数据库为空，初始化脚本创建初始数据
2. **后续更新**：数据库已有数据，初始化脚本检测到数据并跳过，保留所有已有数据

## 受保护的数据类型

以下数据在部署更新时都会被保护：

- ✅ **用户数据**：用户名、头像、激活状态等
- ✅ **资产数据**：资产代码、名称、基准价格等
- ✅ **市场数据**：历史价格、成交量、市盈率等
- ✅ **排名数据**：历史排名记录
- ✅ **用户配置**：管理界面中的所有配置

## 验证方法

部署后查看启动日志，应该看到：

```
[数据库初始化] ⚠️  检测到已有 X 个用户，跳过初始化（保护已有数据）
```

而不是：

```
[数据库初始化] ✓ 数据库为空，开始初始化...
```

## 重要提示

1. **Persistent Storage**：在 Hugging Face Spaces 中，必须开启 Persistent Storage，确保数据库文件保存在持久化卷中
2. **备份建议**：虽然数据会被保护，但建议定期备份数据库文件
3. **测试环境**：在生产环境更新前，建议先在测试环境验证

## 更新日志

- 2026-01-XX：增强数据保护机制，添加三重检查，确保绝不覆盖已有数据
