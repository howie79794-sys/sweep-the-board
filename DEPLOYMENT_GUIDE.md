# 部署指南 - 无感更新部署

## 重要说明

本项目的部署配置确保用户数据（个人信息、头像等）在每次更新时不会被覆盖。

## 数据持久化策略

### 1. 用户数据存储位置

- **数据库文件**: `data/database.db`
- **用户头像**: `data/avatars/`

这些文件已添加到 `.gitignore`，**不会**提交到Git仓库。

### 2. 部署时的数据保护

#### GitHub Actions 部署流程

1. **首次部署**:
   - 数据库和头像目录会被创建
   - 初始数据（用户、资产）会被导入

2. **后续更新**:
   - 只更新代码文件
   - **不会覆盖**现有的数据库文件和头像文件
   - 确保数据持久化

#### Hugging Face Spaces 部署

- 使用持久化存储（persistent storage）来保存数据目录
- 确保 `data/` 目录在容器重启后仍然存在

## 配置文件说明

### 开发环境 vs 生产环境

- **开发环境**: 使用 `data/` 目录（相对路径）
- **生产环境**: 可以通过环境变量 `DATA_DIR` 指定数据目录

### 环境变量配置

在生产环境中，可以设置以下环境变量：

```bash
# 数据目录（可选，默认使用 data/）
DATA_DIR=/path/to/persistent/storage

# 数据库路径
DATABASE_URL=sqlite:///path/to/persistent/storage/database.db

# 上传目录（头像存储）
UPLOAD_DIR=/path/to/persistent/storage/avatars
```

## 部署检查清单

- [ ] 确保 `.gitignore` 包含 `data/database.db` 和 `data/avatars/*`
- [ ] 确保部署脚本不会覆盖现有数据库
- [ ] 确保数据目录有持久化存储配置
- [ ] 测试首次部署和更新部署流程

## 无感更新部署流程

### 1. 代码更新

```bash
git add .
git commit -m "更新功能"
git push origin main
```

### 2. 自动部署

- GitHub Actions 自动触发
- 部署到 Hugging Face Spaces
- **现有数据保持不变**

### 3. 验证

- 检查用户数据是否完整
- 检查头像是否正常显示
- 验证新功能是否正常工作

## 注意事项

1. **数据备份**: 定期备份 `data/database.db` 和 `data/avatars/` 目录
2. **迁移脚本**: 如果需要数据库结构变更，需要编写迁移脚本
3. **权限设置**: 确保数据目录有正确的读写权限

## 数据迁移

如果需要更新数据库结构：

1. 编写数据库迁移脚本
2. 在部署时检查数据库版本
3. 自动执行迁移（如果版本不匹配）
4. 确保向后兼容

## 故障恢复

如果部署出现问题：

1. 数据文件未受影响（已持久化）
2. 回滚到上一个版本
3. 数据仍然可用
